<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ро╣рпЛроЯрпНроЯро▓рпН роЖро░рпНроЯро░рпН - роХро╡рпБрогрпНроЯро░рпН</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        /* Clear Button Styles */
        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .clear-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        .clear-all-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .clear-all-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .completed-badge {
            background: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- ЁЯФР Page Load Security Check -->
    <script>
        (function() {
            const user = localStorage.getItem('hotelUser');
            if (!user) {
                window.location.href = '/login';
            }
        })();
    </script>

    <div class="container">
        <!-- Logout Button -->
        <button onclick="handleLogout()" class="logout-btn" title="ро╡рпЖро│ро┐ропрпЗро▒рпБ">
            <span>ЁЯЪк</span> ро╡рпЖро│ро┐ропрпЗро▒рпБ
        </button>

        <!-- Logout Script -->
        <script type="module">
            import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
            import firebaseConfig from '/firebase-config.js';
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            
            window.handleLogout = async function() {
                try {
                    await signOut(auth);
                    localStorage.removeItem('hotelUser');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('тЭМ ро╡рпЖро│ро┐ропрпЗро▒ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ: ' + error.message);
                }
            };
        </script>

        <div class="header">
            <h1>ЁЯПи ро╣рпЛроЯрпНроЯро▓рпН роЖро░рпНроЯро░рпН роЪро┐ро╕рпНроЯроорпН</h1>
            <p>роХро╡рпБрогрпНроЯро░рпН - рокрпБродро┐роп роЖро░рпНроЯро░рпН роОроЯрпБроХрпНроХ</p>
        </div>

        <div class="grid">
            <!-- Order Form -->
            <div class="card">
                <h2>ЁЯУЭ рокрпБродро┐роп роЖро░рпНроЯро░рпН</h2>
                
                <div class="form-group">
                    <label>ро╡ро╛роЯро┐роХрпНроХрпИропро╛ро│ро░рпН рокрпЖропро░рпН:</label>
                    <input type="text" id="customerName" class="form-control" placeholder="рокрпЖропро░рпН (ро╡ро┐ро░рпБрокрпНрокроорпН)">
                </div>

                <div class="form-group">
                    <label>роорпЗроЬрпИ роОрогрпН:</label>
                    <input type="text" id="tableNo" class="form-control" placeholder="роорпЗроЬрпИ роОрогрпН">
                </div>

                <div class="form-group">
                    <label>роРроЯрпНроЯроорпН родрпЗро░рпНроирпНродрпЖроЯрпБ:</label>
                    <select id="itemSelect" class="form-control">
                        <option value="рокро░ро╛роЯрпНроЯро╛">ЁЯлУ рокро░ро╛роЯрпНроЯро╛ - тВ╣50</option>
                        <option value="роЯрпА">тШХ роЯрпА - тВ╣20</option>
                        <option value="роЬрпВро╕рпН">ЁЯед роЬрпВро╕рпН - тВ╣80</option>
                        <option value="ро░рпИро╕рпН">ЁЯНЪ ро░рпИро╕рпН - тВ╣120</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>роЕро│ро╡рпБ:</label>
                    <input type="number" id="quantity" class="form-control" value="1" min="1" max="10">
                </div>

                <button onclick="sendOrder()" class="btn btn-primary" style="width: 100%;">
                    ЁЯЪА роЖро░рпНроЯро░рпН роЕройрпБрокрпНрокрпБ
                </button>
            </div>

            <!-- Active Orders -->
            <div class="card">
                <h2>ЁЯФД роиро┐ро▓рпБро╡рпИропро┐ро▓рпН роЙро│рпНро│ роЖро░рпНроЯро░рпНроХро│рпН</h2>
                <div id="activeOrders">
                    <p>роЖро░рпНроЯро░рпНроХро│рпН роПродрпБрооро┐ро▓рпНро▓рпИ</p>
                </div>
            </div>
        </div>

        <!-- All Orders Display with Clear All Button -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ЁЯУЛ роЕройрпИродрпНродрпБ роЖро░рпНроЯро░рпНроХро│рпБроорпН</h2>
                <button onclick="clearAllCompletedOrders()" class="clear-all-btn" id="clearAllBtn" style="display: none;">
                    ЁЯЧСя╕П роЕройрпИродрпНродрпБ роорпБроЯро┐роирпНрод роЖро░рпНроЯро░рпНроХро│рпИропрпБроорпН роирпАроХрпНроХрпБ
                </button>
            </div>
            <div id="ordersList"></div>
        </div>
    </div>

    <!-- Firebase SDK for Orders -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, push, onValue, query, orderByChild, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import firebaseConfig from '/firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Send Order Function
        window.sendOrder = async function() {
            const customerName = document.getElementById('customerName').value || 'ро╡ро╛роЯро┐роХрпНроХрпИропро╛ро│ро░рпН';
            const tableNo = document.getElementById('tableNo').value || '0';
            const item = document.getElementById('itemSelect').value;
            const quantity = document.getElementById('quantity').value;

            if (!item || quantity < 1) {
                alert('родропро╡рпБроЪрпЖропрпНродрпБ роЪро░ро┐ропро╛рой родроХро╡ро▓рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН');
                return;
            }

            const orderRef = ref(db, 'orders');
            const newOrder = {
                customerName,
                tableNo,
                item,
                quantity: parseInt(quantity),
                status: 'new',
                timestamp: Date.now(),
                station: item === 'рокро░ро╛роЯрпНроЯро╛' ? 'parotta' : 
                        item === 'роЯрпА' ? 'tea' :
                        item === 'роЬрпВро╕рпН' ? 'juice' : 'rice'
            };

            try {
                await push(orderRef, newOrder);
                showNotification('тЬЕ роЖро░рпНроЯро░рпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роЕройрпБрокрпНрокрокрпНрокроЯрпНроЯродрпБ!');
                
                // Clear form
                document.getElementById('customerName').value = '';
                document.getElementById('tableNo').value = '';
                document.getElementById('quantity').value = '1';
            } catch (error) {
                console.error(error);
                showNotification('тЭМ рокро┐ро┤рпИ: ' + error.message, 'error');
            }
        };

        // Real-time listener for all orders
        const ordersRef = ref(db, 'orders');
        const recentOrdersQuery = query(ordersRef, orderByChild('timestamp'));

        onValue(recentOrdersQuery, (snapshot) => {
            const orders = [];
            snapshot.forEach(childSnapshot => {
                orders.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });

            // Sort by timestamp (newest first)
            orders.sort((a, b) => b.timestamp - a.timestamp);

            // Update UI
            updateOrdersDisplay(orders);
            updateActiveOrders(orders);
            
            // Show/hide Clear All button
            const completedOrders = orders.filter(o => o.status === 'completed');
            const clearAllBtn = document.getElementById('clearAllBtn');
            if (clearAllBtn) {
                clearAllBtn.style.display = completedOrders.length > 0 ? 'inline-flex' : 'none';
            }
        });

        // Update all orders display with Clear button for completed orders
        function updateOrdersDisplay(orders) {
            const ordersList = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p>роЗродрпБро╡ро░рпИ роЖро░рпНроЯро░рпНроХро│рпН роЗро▓рпНро▓рпИ</p>';
                return;
            }

            let html = '<div class="grid">';
            orders.slice(0, 20).forEach(order => {
                const time = new Date(order.timestamp).toLocaleTimeString('ta-IN');
                const statusColor = getStatusColor(order.status);
                
                html += `
                    <div class="order-card" style="border-left-color: ${statusColor}">
                        <div class="order-header">
                            <div>
                                <span class="order-item">${order.item} (${order.quantity})</span>
                                <span class="order-status status-${order.status}">${order.status}</span>
                            </div>
                            <div class="order-actions">
                                ${order.status === 'completed' ? 
                                    `<button onclick="clearSingleOrder('${order.id}')" class="clear-btn" title="роЗроирпНрод роЖро░рпНроЯро░рпИ роирпАроХрпНроХрпБ">
                                        ЁЯЧСя╕П Clear
                                    </button>` : 
                                    ''
                                }
                            </div>
                        </div>
                        <p><strong>ЁЯСд ${order.customerName}</strong> | роорпЗроЬрпИ ${order.tableNo}</p>
                        <p><small>тП░ ${time}</small></p>
                    </div>
                `;
            });
            html += '</div>';
            
            ordersList.innerHTML = html;
        }

        // Update active orders (not completed)
        function updateActiveOrders(orders) {
            const active = orders.filter(o => o.status !== 'completed');
            const activeDiv = document.getElementById('activeOrders');
            
            if (active.length === 0) {
                activeDiv.innerHTML = '<p>тЬЕ роЕройрпИродрпНродрпБ роЖро░рпНроЯро░рпНроХро│рпБроорпН роорпБроЯро┐роирпНродрпБро╡ро┐роЯрпНроЯрой</p>';
                return;
            }

            let html = '';
            active.slice(0, 5).forEach(order => {
                const time = new Date(order.timestamp).toLocaleTimeString('ta-IN');
                
                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <span class="order-item">${order.item} (${order.quantity})</span>
                            <span class="order-status status-${order.status}">${order.status}</span>
                        </div>
                        <p><strong>${order.customerName}</strong> | роорпЗроЬрпИ ${order.tableNo}</p>
                        <p><small>тП░ ${time}</small></p>
                    </div>
                `;
            });
            
            if (active.length > 5) {
                html += `<p style="text-align:center;">+ ${active.length - 5} роЖро░рпНроЯро░рпНроХро│рпН роорпЗро▓рпБроорпН</p>`;
            }
            
            activeDiv.innerHTML = html;
        }

        // тЬЕ NEW FUNCTION: Clear single completed order
        window.clearSingleOrder = async function(orderId) {
            if (!confirm('роЗроирпНрод роЖро░рпНроЯро░рпИ роиро┐роЪрпНроЪропрооро╛роХ роирпАроХрпНроХро╡ро╛?')) {
                return;
            }
            
            try {
                const orderRef = ref(db, `orders/${orderId}`);
                await remove(orderRef);
                showNotification('тЬЕ роЖро░рпНроЯро░рпН роирпАроХрпНроХрокрпНрокроЯрпНроЯродрпБ');
            } catch (error) {
                console.error('Error clearing order:', error);
                showNotification('тЭМ рокро┐ро┤рпИ: ' + error.message, 'error');
            }
        };

        // тЬЕ NEW FUNCTION: Clear all completed orders
        window.clearAllCompletedOrders = async function() {
            const ordersRef = ref(db, 'orders');
            const snapshot = await getOrdersSnapshot();
            
            if (!snapshot.exists()) {
                showNotification('тЭМ роирпАроХрпНроХ роЖро░рпНроЯро░рпНроХро│рпН роЗро▓рпНро▓рпИ', 'error');
                return;
            }
            
            const completedOrders = [];
            snapshot.forEach(childSnapshot => {
                const order = childSnapshot.val();
                if (order.status === 'completed') {
                    completedOrders.push(childSnapshot.key);
                }
            });
            
            if (completedOrders.length === 0) {
                showNotification('тЬЕ роорпБроЯро┐роирпНрод роЖро░рпНроЯро░рпНроХро│рпН роЗро▓рпНро▓рпИ', 'success');
                return;
            }
            
            if (!confirm(`роорпКродрпНродроорпН ${completedOrders.length} роорпБроЯро┐роирпНрод роЖро░рпНроЯро░рпНроХро│рпИ роиро┐роЪрпНроЪропрооро╛роХ роирпАроХрпНроХро╡ро╛?`)) {
                return;
            }
            
            try {
                // Delete each completed order
                for (const orderId of completedOrders) {
                    const orderRef = ref(db, `orders/${orderId}`);
                    await remove(orderRef);
                }
                showNotification(`тЬЕ ${completedOrders.length} роЖро░рпНроЯро░рпНроХро│рпН роирпАроХрпНроХрокрпНрокроЯрпНроЯрой`);
            } catch (error) {
                console.error('Error clearing orders:', error);
                showNotification('тЭМ рокро┐ро┤рпИ: ' + error.message, 'error');
            }
        };

        // Helper function to get orders snapshot
        async function getOrdersSnapshot() {
            const ordersRef = ref(db, 'orders');
            const { get } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js");
            return get(ordersRef);
        }
    </script>

    <!-- Helper functions -->
    <script>
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'success' ? '#27ae60' : '#e74c3c';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function getStatusColor(status) {
            const colors = {
                'new': '#3498db',
                'received': '#f39c12',
                'preparing': '#e67e22',
                'ready': '#27ae60',
                'completed': '#95a5a6'
            };
            return colors[status] || '#95a5a6';
        }
    </script>
</body>
</html>